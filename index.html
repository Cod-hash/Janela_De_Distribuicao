<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BerryHouse - Consulta de Entrega por CEP</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  
  <style>
    /* Reset e Estilos Globais */
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Dancing+Script:wght@400;500;600;700&display=swap');

    :root {
      --color-background: #fdfcf9; /* Fundo off-white do site de referência */
      --color-text: #2d2d2d;       /* Cor de texto principal, preto suave */
      --color-primary: #8c3b3b;   /* Vermelho/vinho principal (Berry) */
      --color-primary-light: #a35d5d;
      --color-primary-dark: #6b2d2d;
      --color-muted: #9e9e9e;      /* Cinza para textos secundários */
      --color-disabled: #e0e0e0;   /* Fundo de elementos desabilitados */
      --color-border: #dcdcdc;     /* Cor da borda sutil */
      --color-success: #28a745;    /* Verde para sucessos */
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-hover: 0 6px 20px rgba(0, 0, 0, 0.12);
             --border-radius: 10px;
       --border-radius-lg: 16px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background: linear-gradient(135deg, #fdfcf9 0%, #f8f6f0 100%);
      color: var(--color-text);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 2rem;
      min-height: 100vh;
      line-height: 1.6;
    }

    /* Estrutura Principal */
    .container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
      width: 100%;
      max-width: 1200px;
      margin-bottom: 80px; /* Espaço para o rodapé */
    }

    @media (min-width: 992px) {
      .container {
        grid-template-columns: 400px 1fr;
        margin-bottom: 80px; /* Espaço para o rodapé */
      }
    }

    .card {
      background-color: white;
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow);
      padding: 2rem;
      border: 1px solid rgba(140, 59, 59, 0.1);
      transition: all 0.3s ease;
      position: relative;
      z-index: 10;
    }

    .card:hover {
      box-shadow: var(--shadow-hover);
      transform: translateY(-2px);
    }

    /* Header Empresarial */
    .header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 2px solid var(--color-primary-light);
    }

    .logo {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .logo img {
      max-width: 200px;
      height: auto;
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: var(--color-muted);
      font-size: 0.95rem;
      font-weight: 500;
      letter-spacing: 0.3px;
    }

    /* Seções e Títulos */
    .section {
      margin-bottom: 2rem;
    }
    .section:last-child {
      margin-bottom: 0;
    }

    h2 {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1.2rem;
      color: var(--color-primary);
      border-bottom: 2px solid var(--color-primary-light);
      padding-bottom: 0.75rem;
      position: relative;
    }

    h2::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 40px;
      height: 2px;
      background: var(--color-primary);
      border-radius: 1px;
    }
    
    .search-box {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    /* Formulário */
    #cepInput {
      flex-grow: 1;
      border: 2px solid var(--color-border);
      border-radius: var(--border-radius);
      padding: 0.875rem 1rem;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.3s ease;
      background: #fafafa;
    }

    #cepInput:focus {
      outline: none;
      border-color: var(--color-primary);
      background: white;
      box-shadow: 0 0 0 3px rgba(140, 59, 59, 0.15);
      transform: translateY(-1px);
    }

    #cepInput::placeholder {
      color: var(--color-muted);
      font-weight: 400;
    }
    
    .btn {
      border: none;
      border-radius: var(--border-radius);
      padding: 0.875rem 1.5rem;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      letter-spacing: 0.3px;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light));
      color: white;
      box-shadow: 0 4px 15px rgba(140, 59, 59, 0.3);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, var(--color-primary-dark), var(--color-primary));
      box-shadow: 0 6px 20px rgba(140, 59, 59, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--color-disabled), #d0d0d0);
      color: var(--color-text);
      border: 1px solid var(--color-border);
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #d0d0d0, var(--color-disabled));
      border-color: var(--color-primary-light);
    }

    /* Resultados da Busca */
    #endereco .zona { 
      font-weight: 700; 
      font-size: 1.2em; 
      color: var(--color-primary); 
      display: block;
      margin-bottom: 0.5rem;
    }
    
    #endereco .bairros { 
      color: var(--color-text); 
      font-weight: 500;
      font-size: 1.1em;
    }
    
    #endereco .cep-faixa { 
      color: var(--color-muted); 
      font-size: 0.95em; 
      margin-top: 0.75rem;
      padding: 0.75rem;
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: var(--border-radius);
      border-left: 4px solid var(--color-primary);
      font-weight: 500;
    }

    /* Pílulas de Dias e Datas */
    .pills-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: 0.75rem;
    }

    .pill {
      background-color: var(--color-disabled);
      color: var(--color-muted);
      padding: 0.75rem 1.25rem;
      border-radius: 25px;
      font-size: 0.9rem;
      font-weight: 500;
      text-align: center;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      cursor: default;
      position: relative;
      overflow: hidden;
    }

    .pill.active {
      background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light));
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(140, 59, 59, 0.3);
    }

    .pill.active.selected {
      background: linear-gradient(135deg, var(--color-primary-dark), var(--color-primary));
      box-shadow: 0 0 0 3px var(--color-primary-light);
      transform: scale(1.05);
    }

    .pill.active:hover {
      background: linear-gradient(135deg, var(--color-primary-light), var(--color-primary));
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(140, 59, 59, 0.4);
    }
    
    #datas .pill {
      background: linear-gradient(135deg, var(--color-success), #34ce57);
      color: white;
      box-shadow: 0 2px 10px rgba(40, 167, 69, 0.3);
    }

    /* Estilos para Feriados e Datas Especiais */
    .pill.feriado-nacional {
      background: linear-gradient(135deg, #dc3545, #c82333);
      color: white;
      box-shadow: 0 2px 10px rgba(220, 53, 69, 0.3);
      position: relative;
    }

    .pill.feriado-nacional::after {
      content: "!";
      position: absolute;
      top: -8px;
      right: -8px;
      font-size: 0.8rem;
      background: #dc3545;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      font-weight: bold;
    }

    .pill.feriado-sp {
      background: linear-gradient(135deg, #fd7e14, #e55a00);
      color: white;
      box-shadow: 0 2px 10px rgba(253, 126, 20, 0.3);
      position: relative;
    }

    .pill.feriado-sp::after {
      content: "!";
      position: absolute;
      top: -8px;
      right: -8px;
      font-size: 0.8rem;
      background: #fd7e14;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      font-weight: bold;
    }

    .pill.data-especial {
      background: linear-gradient(135deg, #6f42c1, #5a2d91);
      color: white;
      box-shadow: 0 2px 10px rgba(111, 66, 193, 0.3);
      position: relative;
    }

    .pill.data-especial::after {
      content: "i";
      position: absolute;
      top: -8px;
      right: -8px;
      font-size: 0.8rem;
      background: #6f42c1;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      font-weight: bold;
      font-style: italic;
    }

    /* Tooltip para feriados */
    .feriado-tooltip {
      position: relative;
      cursor: help;
    }

    .feriado-tooltip:hover::before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 0.5rem;
      border-radius: 6px;
      font-size: 0.8rem;
      white-space: nowrap;
      z-index: 1000;
      margin-bottom: 5px;
    }

    .feriado-tooltip:hover::after {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.9);
      margin-bottom: -5px;
    }

    /* Lista de Faixas por Dia */
    #diaSelecionadoLabel {
      font-size: 0.95rem;
      color: var(--color-muted);
      margin-bottom: 1.2rem;
      min-height: 1.2em;
      padding: 0.75rem;
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: var(--border-radius);
      border-left: 3px solid var(--color-primary-light);
      font-weight: 500;
    }

    #listaDia {
      list-style: none;
      max-height: 350px;
      overflow-y: auto;
      padding-right: 10px;
    }

    #listaDia li {
      padding: 1.25rem;
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      margin-bottom: 1rem;
      background: linear-gradient(135deg, #fafbfc, #f8f9fa);
      transition: all 0.3s ease;
      position: relative;
    }

    #listaDia li:hover {
      background: white;
      border-color: var(--color-primary-light);
      box-shadow: var(--shadow);
      transform: translateY(-2px);
    }

    #listaDia .pair {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    #listaDia .badge {
      background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light));
      color: white;
      padding: 0.4rem 1rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(140, 59, 59, 0.3);
    }

    #listaDia .muted {
      color: var(--color-muted);
      font-size: 0.9rem;
      text-align: right;
      font-weight: 500;
    }
    
    /* Toast (notificação melhorada) */
    #toast {
      position: fixed;
      bottom: -100px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light));
      color: white;
      padding: 1.25rem 2rem;
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-hover);
      transition: bottom 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      z-index: 1000;
      font-weight: 600;
      font-size: 1rem;
      max-width: 450px;
      text-align: center;
      line-height: 1.5;
    }

    #toast.show {
      bottom: 5rem;
    }

    /* Mapa */
    .map-container {
      position: relative;
      z-index: 1;
    }

    #map {
      height: 100%;
      min-height: 500px;
      width: 100%;
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow);
      border: 2px solid rgba(140, 59, 59, 0.1);
      position: relative;
      z-index: 1;
    }

    /* Scrollbar personalizada */
    #listaDia::-webkit-scrollbar {
      width: 8px;
    }

    #listaDia::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    #listaDia::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light));
      border-radius: 4px;
    }

    #listaDia::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, var(--color-primary-dark), var(--color-primary));
    }

    /* Animações */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeInUp 0.6s ease-out;
    }

    /* Responsividade melhorada */
    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }
      
      .container {
        gap: 1.5rem;
        margin-bottom: 100px; /* Mais espaço no mobile */
      }
      
      .card {
        padding: 1.5rem;
      }
      
      .search-box {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
      
      #map {
        min-height: 400px;
      }
    }

    /* Créditos do Desenvolvedor */
    .developer-credits {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, rgba(140, 59, 59, 0.95), rgba(163, 93, 93, 0.95));
      backdrop-filter: blur(10px);
      border-top: 2px solid var(--color-primary);
      padding: 0.75rem 0;
      z-index: 1000;
      box-shadow: 0 -4px 20px rgba(140, 59, 59, 0.3);
    }

    .credits-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      text-align: center;
    }

    .credits-text {
      color: rgba(255, 255, 255, 0.9);
      font-size: 0.9rem;
      font-weight: 500;
    }

    .developer-link {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
      color: white;
      font-weight: 600;
      padding: 0.5rem 1rem;
      border-radius: 25px;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }

    .developer-link:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .developer-name {
      font-size: 0.95rem;
      letter-spacing: 0.3px;
    }

    .github-icon {
      font-size: 1.1rem;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    /* Ajuste para o toast não sobrepor os créditos */
    #toast.show {
      bottom: 5rem;
    }

    /* Responsividade dos créditos */
    @media (max-width: 768px) {
      .credits-content {
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .developer-link {
        padding: 0.4rem 0.8rem;
      }
      
      .credits-text {
        font-size: 0.85rem;
      }
      
      .developer-name {
        font-size: 0.9rem;
      }
    }
  
    /* ==== Abas superiores ==== */
    .top-tabs {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto 1.5rem auto;
      display: flex;
      gap: 0.75rem;
      justify-content: flex-start;
      align-items: center;
    }
    .tab-btn {
      background: white;
      border: 1px solid rgba(140,59,59,0.12);
      border-radius: 999px;
      padding: 0.5rem 1.15rem;
      font-weight: 600;
      color: #8c3b3b;
      display: flex;
      gap: 0.35rem;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0,0,0,.03);
      cursor: pointer;
      transition: all .15s ease-in-out;
    }
    .tab-btn[aria-selected="true"] {
      background: linear-gradient(135deg, #8c3b3b, #a35d5d);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 6px 14px rgba(140, 59, 59, .28);
    }
    .hidden { position: absolute !important; left: -99999px !important; }
    /* dark store layout */
    #panel-darkstore .container {
      grid-template-columns: 400px 1fr;
    }
    #darkMap {
      height: 100%;
      min-height: 500px;
      width: 100%;
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow);
      border: 2px solid rgba(140, 59, 59, 0.1);
    }
    .darkstore-row {
      display: flex;
      gap: .75rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .result-pill {
      padding: .55rem 1rem;
      border-radius: 999px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: .25rem;
      margin-top: .3rem;
    }
    .result-ok { background: rgba(40,167,69,.12); color: #1e7e34; border: 1px solid rgba(40,167,69,.35); }
    .result-bad { background: rgba(220,53,69,.12); color: #8a2633; border: 1px solid rgba(220,53,69,.35); }
    @media (max-width: 992px) {
      #panel-darkstore .container {
        grid-template-columns: 1fr;
      }
      .top-tabs { justify-content: center; }
    }

  
    /* --- Debug Overlay --- */
    #debugBox{
      position: fixed; bottom: 82px; right: 16px; width: 360px; max-height: 48vh;
      background: rgba(20,20,20,.92); color: #e5e7eb; font: 12px/1.35 monospace;
      border: 1px solid rgba(255,255,255,.15); border-radius: 10px; padding: 8px 10px;
      z-index: 9999; box-shadow: 0 12px 26px rgba(0,0,0,.45); display:none; overflow:auto;
    }
    #debugBtn{
      position: fixed; bottom: 16px; right: 16px; z-index: 9999;
      background:#8c3b3b; color:#fff; border:none; border-radius: 999px; padding:10px 14px; cursor:pointer;
      box-shadow: 0 4px 12px rgba(140,59,59,.4);
    }
  
    /* Force Dark Store map to be always visible and sized */
    #darkMap{
      display:block !important;
      position: relative !important;
      z-index: 1 !important;
      width: 100% !important;
      height: 640px !important;
      min-height: 640px !important;
      background:#f7f7f7;
    }
    #panel-darkstore main.map-container{ display:block !important; }
    #panel-darkstore .container{ display:grid; grid-template-columns: 380px 1fr; gap: 1rem; align-items:start; }
    @media (max-width: 980px){
      #panel-darkstore .container{ grid-template-columns: 1fr; }
    }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>

  
  <div class="top-tabs" role="tablist" aria-label="Visualizações">
    <button id="tab-cep" class="tab-btn" role="tab" aria-selected="true" aria-controls="panel-cep">📦 Consulta CEP</button>
    <button id="tab-dark" class="tab-btn" role="tab" aria-selected="false" aria-controls="panel-darkstore">🏪 Base Dark Store</button>
  </div>

  <div id="panels-stack" style="position:relative; min-height: 760px;">
  <div id="panel-cep" role="tabpanel" aria-labelledby="tab-cep">

  <div class="container">
    <aside class="panel">
      <div class="card">
        
       <header style="width: 100%; background: #fff; padding: 10px 0; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
  <div style="display: flex; justify-content: center; align-items: center; gap: 20px;">
    <img src="static/Berrygood_logo.png" alt="Berry Good Logo" style="max-width: 150px; height: auto;">
    <img src="static/Berryhouse_logo.png" alt="Berry House Logo" style="max-width: 150px; height: auto;">
  </div>
</header>

        
        <section class="section">
          <h2>Consultar CEP</h2>
          <div class="search-box">
            <input type="text" id="cepInput" placeholder="Digite seu CEP (ex: 06412-240)" maxlength="9">
            <button id="btnBuscar" class="btn btn-primary">Buscar</button>
          </div>
          <button id="btnDemo" class="btn btn-secondary" style="width:100%;">Usar CEP de Exemplo</button>
        </section>

        <section id="results" class="section fade-in" hidden>
            <h2>Região Encontrada</h2>
            <div id="endereco"></div>
            
            <h3 style="font-size: 1rem; margin-top: 1.5rem; margin-bottom: 0.75rem;">Dias de Entrega</h3>
            <div id="dias" class="pills-container"></div>
            
            <h3 style="font-size: 1rem; margin-top: 1.5rem; margin-bottom: 0.75rem;">Próximas Datas</h3>
            <div id="datas" class="pills-container"></div>
            
            <div id="feriadosAviso" style="margin-top: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #fff3cd, #ffeaa7); border: 1px solid #ffc107; border-radius: var(--border-radius); display: none;">
              <h4 style="margin: 0 0 0.75rem 0; color: #856404; font-size: 0.95rem; display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 1.2rem; color: #856404;">!</span>
                <strong>Atenção: Feriados e Datas Especiais</strong>
              </h4>
              <div id="feriadosLista" style="font-size: 0.9rem; color: #856404; line-height: 1.4;"></div>
            </div>
        </section>

      </div>
      
      <div class="card" style="margin-top: 2rem;">
         <section class="section">
           <h2 style="margin-bottom: 0.5rem;">Malha de Atendimento</h2>
           <p id="diaSelecionadoLabel">Consulte um CEP para ver os dias de entrega disponíveis.</p>
           <ul id="listaDia"></ul>
         </section>
      </div>

    </aside>

    <main class="map-container">
      <div id="map"></div>
    </main>
  </div>

  <!-- Créditos do Desenvolvedor -->
  
  </div> <!-- /#panel-cep -->
  </div><!-- /#panels-stack -->

  <div id="panel-darkstore" class="hidden" role="tabpanel" aria-labelledby="tab-dark">
    <div class="container">
      <aside class="panel">
        <div class="card">
          <header style="width: 100%; background: #fff; padding: 10px 0; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom:1rem;">
            <div style="display: flex; justify-content: center; align-items: center; gap: 20px;">
              <img src="static/Berrygood_logo.png" alt="Berry Good Logo" style="max-width: 150px; height: auto;">
              <img src="static/Berryhouse_logo.png" alt="Berry House Logo" style="max-width: 150px; height: auto;">
            </div>
          </header>
          <section class="section">
            <h2>🏪 Base Dark Store</h2>
            <p>Endereço-base fixo:</p>
            <p><strong>R. Cel. Domingos Ferreira, 23 – Cursino, São Paulo – SP</strong></p>
          </section>
          <section class="section">
            <label for="dark-radius" style="font-weight:600;">Raio de cobertura (0 – 10 km)</label>
            <div class="darkstore-row" style="margin-top:.35rem;">
              <input id="dark-radius" type="range" min="0" max="10" step="0.5" value="5" style="flex:1;">
              <span id="dark-radius-value" class="pill" style="background:#f1f1f1;">5,0 km</span>
            </div>
            <p id="dark-area" class="muted" style="margin-top:.35rem;">Área coberta: ~78,5 km²</p>
          </section>
          <section class="section">
            <label for="darkstore-search" style="font-weight:600;">Pesquisar endereço ou CEP</label>
            <div class="darkstore-row" style="margin-top:.35rem;">
              <input id="darkstore-search" type="text" placeholder="Ex.: Av. Paulista, 1000 ou 06412-240" style="flex:1; border: 2px solid var(--color-border); border-radius: var(--border-radius); padding:.6rem .75rem; background:#fafafa;">
              <button id="darkstore-btn" class="btn btn-primary">Buscar</button>
            </div>
            <div id="darkstore-result"></div>
            <div class="darkstore-row" style="margin-top:.5rem;">
              <button id="dark-btn-center" class="btn btn-secondary">Centralizar base</button>
              <button id="dark-btn-max" class="btn btn-primary">Usar 10 km</button>
              <button id="dark-btn-clear" class="btn btn-secondary">Limpar pontos</button>
            </div>
          </section>
        </div>
      </aside>
      <main class="map-container">
        <div id="darkMap"></div>
      </main>
    </div>
  </div>

  <footer class="developer-credits">
    <div class="credits-content">
      <span class="credits-text">Desenvolvido por</span>
      <a href="https://github.com/Cod-hash" target="_blank" class="developer-link">
        <span class="developer-name">Marcos André Gois Marcondes</span>
        <span class="github-icon">🐙</span>
      </a>
    </div>
  </footer>

  <div id="toast"></div>

  <script>
    // ----- INÍCIO DO ESCOPO DO SCRIPT -----
    document.addEventListener('DOMContentLoaded', () => {

      // ----- DADOS COMPLETOS DA MALHA DE CEPs -----
      const rowsRaw = [
        // --------- SÃO PAULO (CAPITAL) ----------
        { zona:"São Paulo - Centro", bairros:"Sé / República / Sta.Efigênia / Centro",
          cep_inicio:"01000", cep_fim:"01599", seg:"*", ter:"*", qua:"*", qui:"*", sex:"*", sab:"*",
          lat:-23.5505, lon:-46.6333 },

        { zona:"São Paulo - Norte", bairros:"ZN (02000–02999)",
          cep_inicio:"02000", cep_fim:"02999", seg:"",  ter:"*", qua:"", qui:"*",  sex:"", sab:"*",
          lat:-23.5035, lon:-46.6236 },

        { zona:"São Paulo - Sul", bairros:"ZS (04000–04999)",
          cep_inicio:"04000", cep_fim:"04999", seg:"*", ter:"*", qua:"*", qui:"*", sex:"*", sab:"*",
          lat:-23.6270, lon:-46.6510 },

        { zona:"São Paulo - Leste (03000–03999)", bairros:"ZL – Brás/Mooca/Tatuapé/…",
          cep_inicio:"03000", cep_fim:"03999", seg:"*", ter:"*",  qua:"*", qui:"*",  sex:"*", sab:"*",
          lat:-23.5450, lon:-46.5600 },

        { zona:"São Paulo - Leste (08000–08399)", bairros:"ZL – São Miguel/Itaim/Itaquera/S.Mateus",
          cep_inicio:"08000", cep_fim:"08399", seg:"",  ter:"*", qua:"", qui:"*",  sex:"", sab:"*",
          lat:-23.5200, lon:-46.4700 },

        { zona:"São Paulo - Oeste", bairros:"ZO (05000–05999)",
          cep_inicio:"05000", cep_fim:"05999", seg:"*", ter:"*",  qua:"*", qui:"*",  sex:"*", sab:"*",
          lat:-23.5320, lon:-46.7000 },

        // --------- REGIÃO ABC ----------
        { zona:"Região ABC", bairros:"Santo André / São Bernardo / São Caetano",
          cep_inicio:"09000", cep_fim:"09999", seg:"",  ter:"*", qua:"", qui:"*",  sex:"", sab:"*",
          lat:-23.6633, lon:-46.5320 },

        // --------- BARUERI / COTIA / OSASCO (mesma janela) ----------
        { zona:"Região Barueri/Cotia/Osasco", bairros:"Osasco",
          cep_inicio:"06000", cep_fim:"06299", seg:"",  ter:"*", qua:"", qui:"*",  sex:"", sab:"*",
          lat:-23.5329, lon:-46.7916 },

        { zona:"Região Barueri/Cotia/Osasco", bairros:"Carapicuíba / Jandira / Itapevi",
          cep_inicio:"06300", cep_fim:"06699",seg:"",  ter:"*", qua:"", qui:"*",  sex:"", sab:"*",
          lat:-23.5350, lon:-46.8400 },

        { zona:"Região Barueri/Cotia/Osasco", bairros:"Barueri",
          cep_inicio:"06400", cep_fim:"06499", seg:"",  ter:"*", qua:"", qui:"*",  sex:"", sab:"*",
          lat:-23.5057, lon:-46.8790 },

        { zona:"Região Barueri/Cotia/Osasco", bairros:"Cotia",
          cep_inicio:"06700", cep_fim:"06719", seg:"",  ter:"*", qua:"", qui:"*",  sex:"", sab:"*",
          lat:-23.6039, lon:-46.9189 },

        // --------- GUARULHOS / MOGI / SUZANO / ARUJÁ ----------
        { zona:"Guarulhos/Mogi/Suzano/Aruja", bairros:"Guarulhos",
          cep_inicio:"07000", cep_fim:"07399", seg:"",  ter:"*", qua:"", qui:"*",  sex:"", sab:"*",
          lat:-23.4538, lon:-46.5333 },

        { zona:"Guarulhos/Mogi/Suzano/Aruja", bairros:"Arujá",
          cep_inicio:"07400", cep_fim:"07499", seg:"",  ter:"*", qua:"", qui:"*",  sex:"", sab:"*",
          lat:-23.3964, lon:-46.3181 },

        { zona:"Guarulhos/Mogi/Suzano/Aruja", bairros:"Suzano",
          cep_inicio:"08600", cep_fim:"08699",seg:"",  ter:"*", qua:"", qui:"*",  sex:"", sab:"*",
          lat:-23.5428, lon:-46.3117 },

        { zona:"Guarulhos/Mogi/Suzano/Aruja", bairros:"Mogi das Cruzes",
          cep_inicio:"08700", cep_fim:"08799", seg:"",  ter:"*", qua:"", qui:"*",  sex:"", sab:"*",
          lat:-23.5227, lon:-46.1883 },

        // --------- JUNDIAÍ ----------
        { zona:"Região Jundiaí", bairros:"Jundiaí",
          cep_inicio:"13200", cep_fim:"13299", seg:"", ter:"",  qua:"", qui:"*", sex:"", sab:"",
          lat:-23.1859, lon:-46.8978 },

        // --------- CAMPINAS / INDAIATUBA ----------
        { zona:"Região Campinas/Indaiatuba", bairros:"Campinas",
          cep_inicio:"13000", cep_fim:"13129", seg:"", ter:"",  qua:"", qui:"*", sex:"", sab:"",
          lat:-22.9099, lon:-47.0626 },

        { zona:"Região Campinas/Indaiatuba", bairros:"Indaiatuba",
          cep_inicio:"13330", cep_fim:"13349", seg:"", ter:"",  qua:"", qui:"*", sex:"", sab:"",
          lat:-23.0902, lon:-47.2181 },

        // --------- SUMARÉ / MOGI-GUAÇU / SÃO JOÃO BOA VISTA ----------
        { zona:"Região Sumaré/Mogi-Guaçu / São João Boa Vista", bairros:"Sumaré",
          cep_inicio:"13170", cep_fim:"13179", seg:"", ter:"*", qua:"", qui:"", sex:"", sab:"",
          lat:-22.8219, lon:-47.2664 },

        { zona:"Região Sumaré/Mogi-Guaçu / São João Boa Vista", bairros:"Mogi-Guaçu",
          cep_inicio:"13840", cep_fim:"13859", seg:"", ter:"*", qua:"", qui:"", sex:"", sab:"",
          lat:-22.3720, lon:-46.9428 },

        { zona:"Região Sumaré/Mogi-Guaçu / São João Boa Vista", bairros:"São João da Boa Vista",
          cep_inicio:"13870", cep_fim:"13879", seg:"", ter:"*", qua:"", qui:"", sex:"", sab:"",
          lat:-21.9696, lon:-46.7946 },

        // --------- ARARAS / RIBEIRÃO PRETO / ARARAQUARA ----------
        { zona:"Região Araras/Ribeirão Preto / Araraquara", bairros:"Araras",
          cep_inicio:"13600", cep_fim:"13619", seg:"", ter:"",  qua:"", qui:"*", sex:"", sab:"",
          lat:-22.3572, lon:-47.3842 },

        { zona:"Região Araras/Ribeirão Preto / Araraquara", bairros:"Ribeirão Preto",
          cep_inicio:"14000", cep_fim:"14099", seg:"", ter:"",  qua:"", qui:"*", sex:"", sab:"",
          lat:-21.1775, lon:-47.8103 },

        { zona:"Região Araras/Ribeirão Preto / Araraquara", bairros:"Araraquara",
          cep_inicio:"14800", cep_fim:"14819", seg:"", ter:"",  qua:"", qui:"*", sex:"", sab:"",
          lat:-21.7947, lon:-48.1756 },

        // --------- SANTOS ----------
        { zona:"Santos", bairros:"Santos (Litoral)",
          cep_inicio:"11000", cep_fim:"11099", seg:"", ter:"",  qua:"", qui:"",  sex:"", sab:"*",
          lat:-23.9608, lon:-46.3336 },

        // --------- SOROCABA ----------
        { zona:"Sorocaba", bairros:"Sorocaba (SP)",
          cep_inicio:"18000", cep_fim:"18109", seg:"", ter:"",  qua:"", qui:"*", sex:"", sab:"",
          lat:-23.5012, lon:-47.4526 }
      ];

      // ----- FERIADOS E DATAS ESPECIAIS -----
      const feriados = [
        // Feriados Nacionais
        { data: "01-01", nome: "Confraternização Universal", tipo: "nacional" },
        { data: "21-04", nome: "Tiradentes", tipo: "nacional" },
        { data: "01-05", nome: "Dia do Trabalho", tipo: "nacional" },
        { data: "07-09", nome: "Independência do Brasil", tipo: "nacional" },
        { data: "12-10", nome: "Nossa Senhora Aparecida", tipo: "nacional" },
        { data: "02-11", nome: "Finados", tipo: "nacional" },
        { data: "15-11", nome: "Proclamação da República", tipo: "nacional" },
        { data: "25-12", nome: "Natal", tipo: "nacional" },
        
        // Feriados de São Paulo
        { data: "25-01", nome: "Aniversário de São Paulo", tipo: "sp" },
        { data: "09-07", nome: "Revolução Constitucionalista", tipo: "sp" },
        
        // Datas Especiais (não são feriados mas podem afetar entregas)
        { data: "24-12", nome: "Véspera de Natal", tipo: "especial" },
        { data: "31-12", nome: "Véspera de Ano Novo", tipo: "especial" },
        { data: "14-02", nome: "Dia dos Namorados", tipo: "especial" },
        { data: "08-03", nome: "Dia da Mulher", tipo: "especial" },
        { data: "12-10", nome: "Dia das Crianças", tipo: "especial" },
        { data: "15-10", nome: "Dia do Professor", tipo: "especial" },
        { data: "20-11", nome: "Dia da Consciência Negra", tipo: "especial" }
      ];

      const diasOrder = ["seg", "ter", "qua", "qui", "sex", "sab"];
      const labelDia = { seg: "Segunda", ter: "Terça", qua: "Quarta", qui: "Quinta", sex: "Sexta", sab: "Sábado" };

      // ----- VARIÁVEIS DE ESTADO -----
      let selectedDay = null;
      let leafletMap = null;
      let leafletMarker = null;

      // ----- ELEMENTOS DO DOM -----
      const cepInput = document.getElementById('cepInput');
      const diasDiv = document.getElementById('dias');
      const datasDiv = document.getElementById('datas');
      const diaSelecionadoLabel = document.getElementById('diaSelecionadoLabel');
      const listaDiaUl = document.getElementById('listaDia');
      const enderecoDiv = document.getElementById('endereco');
      const resultsSection = document.getElementById('results');
      const toastDiv = document.getElementById('toast');
      const feriadosAvisoDiv = document.getElementById('feriadosAviso');
      const feriadosListaDiv = document.getElementById('feriadosLista');

      // ----- FUNÇÕES LÓGICAS (PURAS) -----
      const onlyDigits = s => (s || "").toString().replace(/\D/g, "");
      const normalizeCEP = cep => {
        const d = onlyDigits(cep);
        return d.length >= 5 ? d.slice(0, 5) : d;
      };
      const inRange = (cep5, ini, fim) => {
        const a = parseInt(ini, 10), b = parseInt(fim, 10), c = parseInt(cep5, 10);
        if (Number.isNaN(a) || Number.isNaN(b) || Number.isNaN(c)) return false;
        return c >= a && c <= b;
      };
      const getUpcomingDeliveryDates = (faixa, n) => {
        const out = [];
        const today = new Date();
        const dayMap = { 1: "seg", 2: "ter", 3: "qua", 4: "qui", 5: "sex", 6: "sab" };
        
        for (let i = 0; i < 40 && out.length < n; i++) {
          const d = new Date(today);
          d.setDate(today.getDate() + i);
          const dayKey = dayMap[d.getDay()];
          if (dayKey && faixa[dayKey] === "*") {
            const dataFormatada = d.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: '2-digit' });
            const dataKey = `${d.getDate().toString().padStart(2, '0')}-${(d.getMonth() + 1).toString().padStart(2, '0')}`;
            
            // Verifica se é feriado
            const feriado = feriados.find(f => f.data === dataKey);
            
            out.push({
              data: dataFormatada,
              feriado: feriado,
              dataKey: dataKey
            });
          }
        }
        
        return out;
      };

      // ----- FUNÇÕES DE RENDERIZAÇÃO E UI -----
      const showToast = (message) => {
        toastDiv.textContent = message;
        toastDiv.classList.add('show');
        setTimeout(() => toastDiv.classList.remove('show'), 4000);
      };

      const checkUpcomingHolidays = () => {
        const today = new Date();
        const nextWeek = new Date(today);
        nextWeek.setDate(today.getDate() + 7);
        
        const feriadosProximos = [];
        for (let d = new Date(today); d <= nextWeek; d.setDate(d.getDate() + 1)) {
          const dataKey = `${d.getDate().toString().padStart(2, '0')}-${(d.getMonth() + 1).toString().padStart(2, '0')}`;
          const feriado = feriados.find(f => f.data === dataKey);
          if (feriado) {
            feriadosProximos.push({
              data: d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }),
              feriado: feriado
            });
          }
        }
        
        if (feriadosProximos.length > 0) {
          const mensagem = `ATENÇÃO: Feriados na próxima semana - ${feriadosProximos.map(f => `${f.data} (${f.feriado.nome})`).join(', ')}`;
          showToast(mensagem);
        }
      };

      const updateAvailableDaysUI = (faixa) => {
        diasDiv.innerHTML = "";
        diasOrder.forEach(key => {
          const el = document.createElement('span');
          const isAtivo = faixa[key] === "*";
          el.className = 'pill' + (isAtivo ? ' active' : '');
          el.textContent = labelDia[key];
          if (isAtivo) {
            el.dataset.dayKey = key;
            el.onclick = () => {
              selectedDay = key;
              diaSelecionadoLabel.textContent = `Dia selecionado: ${labelDia[key]} — mostrando todas as faixas atendidas nesse dia.`;
              updateDeliveryListUI();
              document.querySelectorAll('#dias .pill').forEach(p => p.classList.remove('selected'));
              el.classList.add('selected');
            };
          }
          diasDiv.appendChild(el);
        });
      };
      
      const updateDeliveryListUI = () => {
        listaDiaUl.innerHTML = "";
        if (!selectedDay) {
          diaSelecionadoLabel.textContent = "Selecione um dia de entrega para ver a malha completa.";
          return;
        }
        
        const todos = rowsRaw
          .filter(r => r[selectedDay] === "*")
          .sort((a, b) => a.zona.localeCompare(b.zona) || a.cep_inicio.localeCompare(b.cep_inicio));

        if (todos.length === 0) {
          const li = document.createElement('li');
          li.innerHTML = '<span style="color: var(--color-muted); font-style: italic;">Nenhuma faixa de entrega para este dia.</span>';
          listaDiaUl.appendChild(li);
        } else {
          todos.forEach(({ zona, bairros, cep_inicio, cep_fim }) => {
            const li = document.createElement('li');
            li.innerHTML = `
              <div class="pair">
                <span class="badge">${zona}</span>
                <span class="muted">${bairros}</span>
              </div>
              <div style="color: var(--color-text); font-weight: 500;"><b>CEP:</b> ${cep_inicio}000 — ${cep_fim}999</div>
            `;
            listaDiaUl.appendChild(li);
          });
        }
      };

      const updateMap = ({ lat, lon, zona, bairros, cep_inicio, cep_fim }) => {
        if (leafletMarker) leafletMarker.remove();
        
        leafletMarker = L.marker([lat, lon]).addTo(leafletMap)
          .bindPopup(`
            <div style="text-align: center; min-width: 200px;">
              <h4 style="margin: 0 0 0.5rem 0; color: var(--color-primary);">${zona}</h4>
              <p style="margin: 0 0 0.5rem 0; font-weight: 500;">${bairros}</p>
              <p style="margin: 0; color: var(--color-muted); font-size: 0.9rem;">
                CEP: ${cep_inicio}000 — ${cep_fim}999
              </p>
            </div>
          `);
        
        leafletMap.setView([lat, lon], 12);
      };

      // ----- FUNÇÃO PRINCIPAL DE BUSCA -----
      const buscarCep = () => {
        const cep = cepInput.value.trim();
        if (!cep) {
          showToast("Por favor, digite um CEP válido.");
          return;
        }

        const cep5 = normalizeCEP(cep);
        const faixa = rowsRaw.find(r => inRange(cep5, r.cep_inicio, r.cep_fim));

        if (!faixa) {
          showToast("CEP não encontrado na nossa malha de atendimento.");
          resultsSection.hidden = true;
          return;
        }

        // Atualiza a interface
        enderecoDiv.innerHTML = `
          <span class="zona">${faixa.zona}</span>
          <span class="bairros">${faixa.bairros}</span>
          <div class="cep-faixa">CEP: ${faixa.cep_inicio}000 — ${faixa.cep_fim}999</div>
        `;

        updateAvailableDaysUI(faixa);
        
        const datas = getUpcomingDeliveryDates(faixa, 3);
        datasDiv.innerHTML = "";
        
        // Verifica se há feriados nas próximas datas
        const feriadosProximos = datas.filter(dt => dt.feriado);
        
        if (feriadosProximos.length > 0) {
          feriadosAvisoDiv.style.display = 'block';
          feriadosListaDiv.innerHTML = `
            <p style="margin: 0 0 0.5rem 0;"><strong>Feriados identificados nas próximas datas:</strong></p>
            <ul style="margin: 0; padding-left: 1.5rem;">
              ${feriadosProximos.map(dt => `
                <li style="margin-bottom: 0.25rem;">
                  <strong>${dt.data}:</strong> ${dt.feriado.nome}
                  ${dt.feriado.tipo === 'nacional' ? ' <span style="color: #dc3545;">(Feriado Nacional)</span>' : ''}
                  ${dt.feriado.tipo === 'sp' ? ' <span style="color: #fd7e14;">(Feriado SP)</span>' : ''}
                  ${dt.feriado.tipo === 'especial' ? ' <span style="color: #6f42c1;">(Data Especial)</span>' : ''}
                </li>
              `).join('')}
            </ul>
          `;
        } else {
          feriadosAvisoDiv.style.display = 'none';
        }

        datas.forEach(dt => {
          const sp = document.createElement('span');
          sp.className = 'pill';
          sp.innerHTML = `${dt.data}`;
          
          if (dt.feriado) {
            // Aplica a classe CSS baseada no tipo de feriado
            if (dt.feriado.tipo === 'nacional') {
              sp.classList.add('feriado-nacional');
            } else if (dt.feriado.tipo === 'sp') {
              sp.classList.add('feriado-sp');
            } else if (dt.feriado.tipo === 'especial') {
              sp.classList.add('data-especial');
            }
            
            // Adiciona tooltip com informações do feriado
            sp.classList.add('feriado-tooltip');
            sp.setAttribute('data-tooltip', `${dt.feriado.nome} - ${dt.feriado.tipo === 'nacional' ? 'Feriado Nacional' : dt.feriado.tipo === 'sp' ? 'Feriado SP' : 'Data Especial'}`);
          }
          
          datasDiv.appendChild(sp);
        });

        updateMap(faixa);
        resultsSection.hidden = false;
        showToast(`CEP encontrado! ${faixa.zona}`);
      };

      // ----- INICIALIZAÇÃO -----
      const init = () => {
        // Mapa
        leafletMap = L.map('map').setView([-23.55, -46.63], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(leafletMap);

        // Event Listeners
        document.getElementById('btnBuscar').addEventListener('click', buscarCep);
        cepInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') buscarCep();
        });
        document.getElementById('btnDemo').addEventListener('click', () => {
          cepInput.value = "06412-240";
          buscarCep();
        });
        
        updateDeliveryListUI();
        
        // Verifica feriados próximos ao carregar
        setTimeout(checkUpcomingHolidays, 1000);
      };

      // ----- EXECUÇÃO -----
      init();

      // ===== DEBUG HELPERS =====
      (function(){
        const box = document.getElementById('debugBox');
        const btn = document.getElementById('debugBtn');
        window.__dbg = {open:false, logs:[]};
        function ts(){ const d=new Date(); return d.toISOString().slice(11,19) + '.' + d.getMilliseconds().toString().padStart(3,'0'); }
        function log(level, msg, obj){
          const line = `[${ts()}] ${level} ${msg}`;
          console[level === 'ERR' ? 'error' : 'log'](line, obj || '');
          window.__dbg.logs.push(line + (obj ? ' ' + JSON.stringify(obj) : ''));
          if(window.__dbg.open){
            box.style.display='block';
            box.textContent = window.__dbg.logs.slice(-200).join('\\n');
          }
        }
        window.__log = {
          info:(m,o)=>log('INF',m,o),
          warn:(m,o)=>log('WRN',m,o),
          err:(m,o)=>log('ERR',m,o)
        };
        btn.addEventListener('click', ()=>{
          window.__dbg.open = !window.__dbg.open;
          box.style.display = window.__dbg.open ? 'block' : 'none';
          if(window.__dbg.open){ box.textContent = window.__dbg.logs.slice(-200).join('\\n'); }
        });
        window.addEventListener('error', (e)=>{ log('ERR','window.onerror', {msg:e.message, src:e.filename, ln:e.lineno}); });
        window.addEventListener('unhandledrejection', (e)=>{ log('ERR','unhandledrejection', {reason: (e.reason && e.reason.message) || String(e.reason)}); });
        __log.info('Debug helpers loaded');
      })();

      // ===== Leaflet presence check =====
      (function(){
        const present = typeof L !== 'undefined';
        __log.info('Leaflet present?', {present});
      })();

      // ===== Override initDarkTab to add logs if defined later =====
      (function(){
        const _init = (typeof initDarkTab === 'function') ? initDarkTab : null;
        window.initDarkTab = function(){
          __log.info('initDarkTab() called');
          const el = document.getElementById('darkMap');
          if(!el){ __log.err('#darkMap missing'); return; }
          const r = {w: el.clientWidth, h: el.clientHeight, disp: getComputedStyle(el).display, vis: getComputedStyle(el).visibility};
          __log.info('#darkMap size/pre', r);
          try{
            return _init ? _init() : (function(){
              __log.warn('Fallback: original initDarkTab not found (already inlined with logs?)');
            })();
          }catch(e){
            __log.err('initDarkTab exception', {msg:e.message, stack:e.stack});
          }
        };
      })();

      // ===== Patch map creation logs after L.map =====
      (function(){
        const _Lmap = L.map;
        L.map = function(id, opts){
          __log.info('L.map creating', {id});
          const m = _Lmap.call(this, id, opts);
          try{
            m.on('load', ()=>__log.info('map load event'));
            m.on('layeradd', (e)=>__log.info('layer add', {type: e.layer && e.layer.constructor && e.layer.constructor.name}));
            m.on('resize', (e)=>__log.info('map resize', {size: e.newSize}));
          }catch(e){ __log.err('map hook error', {msg:e.message}); }
          return m;
        };
      })();

      // ===== Tile layer error logging =====
      (function(){
        const _tile = L.tileLayer;
        L.tileLayer = function(url, opts){
          const t = _tile.call(this, url, opts);
          try{
            t.on('tileerror', (e)=>__log.err('tile error', {url: e.tile && e.tile.src}));
            t.on('load', ()=>__log.info('tile layer loaded', {urlTemplate: url}));
          }catch(e){ __log.err('tile hook error', {msg:e.message}); }
          return t;
        };
      })();

      // Log when user switches tabs
      (function(){
        const tabCepBtn = document.getElementById('tab-cep');
        const tabDarkBtn = document.getElementById('tab-dark');
        if(tabCepBtn) tabCepBtn.addEventListener('click', ()=>__log.info('Tab -> CEP'));
        if(tabDarkBtn) tabDarkBtn.addEventListener('click', ()=>__log.info('Tab -> Dark Store'));
      })();


      
      // ====== Aba Dark Store (lazy init + XLS) ======
      const tabCep = document.getElementById('tab-cep');
      const tabDark = document.getElementById('tab-dark');
      const panelCep = document.getElementById('panel-cep');
      const panelDark = document.getElementById('panel-darkstore');

      let darkTabInitialized = false;
      let darkMap = null;
      let darkBaseLatLng = null;
      let darkBaseMarker = null;
      let darkCircle = null;
      let darkSearchMarkers = [];
      let darkAllowedAddresses = [];
      let darkXlsLoaded = false;

      // Base fixa (Cursino) — coordenadas aproximadas para evitar depender de geocodificação
      const DARK_BASE_ADDR = "R. Cel. Domingos Ferreira, 23 - Cursino, São Paulo - SP";
      const DARK_BASE_LATLNG = [-23.6125, -46.6240];
      const DARK_XLS_PATH = "SEGUNDA A SABADO SP Ate_10KM - Ajustada.xls";

      function selectTab(which) {
        // Força o darkMap a ter altura antes de inicializar
        const darkDiv = document.getElementById('darkMap');
        if (darkDiv) { darkDiv.style.minHeight = '520px'; darkDiv.style.height = '520px'; }
        const isCep = which === 'cep';
        tabCep.setAttribute('aria-selected', isCep ? 'true' : 'false');
        tabDark.setAttribute('aria-selected', isCep ? 'false' : 'true');
        panelCep.classList.toggle('hidden', !isCep);
        panelDark.classList.toggle('hidden', isCep);
        setTimeout(() => {
          if (!isCep && !darkTabInitialized) {
            initDarkTab();
          } else {
            if (darkMap) darkMap.invalidateSize();
            if (typeof leafletMap !== 'undefined' && leafletMap) leafletMap.invalidateSize();
          }

          if (!isCep && window.darkMap) {
            try {
              window.darkMap.invalidateSize();
              setTimeout(()=> window.darkMap.invalidateSize(), 150);
              setTimeout(()=> window.darkMap.invalidateSize(), 500);
              setTimeout(()=> window.darkMap.invalidateSize(), 1200);
            } catch(_) {}
          }

        }, 200);
      }

      tabCep.addEventListener('click', () => selectTab('cep'));
      tabDark.addEventListener('click', () => selectTab('dark'));

      async function loadDarkXls() {
        if (darkXlsLoaded) return;
        try {
          const res = await fetch(DARK_XLS_PATH);
          const ab = await res.arrayBuffer();
          const wb = XLSX.read(ab, {type:'array'});
          const first = wb.SheetNames[0];
          const ws = wb.Sheets[first];
          const json = XLSX.utils.sheet_to_json(ws, {defval: ""});
          darkAllowedAddresses = json.map(row => Object.values(row).join(" ").trim()).filter(Boolean);
          darkXlsLoaded = true;
        } catch(e) {
          console.warn("Falha ao carregar XLS de endereços:", e);
          darkAllowedAddresses = [];
        }
      }

      function haversine(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const toRad = x => x * Math.PI / 180;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2) ** 2 +
                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                  Math.sin(dLon/2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }

      // Geocodificação simples via Nominatim (usada somente para o endereço pesquisado)
      async function geocodeGeneric(q) {
        try {
          const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + encodeURIComponent(q);
          const res = await fetch(url, {headers: {"Accept-Language":"pt-BR"}});
          const js = await res.json();
          if (Array.isArray(js) && js.length) {
            return [parseFloat(js[0].lat), parseFloat(js[0].lon), js[0].display_name];
          }
        } catch(e) {}
        return null;
      }

      function initDarkTab() {
        // Garante que o container está visível e dimensionado antes de criar o mapa
        
        darkTabInitialized = true;

        // cria o mapa imediatamente (painel pode estar off-screen, mas com tamanho válido)
        darkMap = L.map('darkMap'); __log.info('darkMap created');
        // Garantir que o container tenha tamanho antes de setView
        setTimeout(() => { darkMap.invalidateSize(); }, 50);

        // camada de tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap'
        }).addTo(darkMap);
        L.control.scale({metric:true, imperial:false}).addTo(darkMap);

        // usa a coordenada fixa da base
        darkBaseLatLng = DARK_BASE_LATLNG.slice();
        darkMap.setView(darkBaseLatLng, 13); __log.info('darkMap setView applied', {latlng: darkBaseLatLng});
        darkBaseMarker = L.marker(darkBaseLatLng, {title:"Base Dark Store"})
          .addTo(darkMap).bindPopup("<strong>Base Dark Store</strong><br>" + DARK_BASE_ADDR);

        // UI
        const darkRadiusInput = document.getElementById('dark-radius');
        const darkRadiusValue = document.getElementById('dark-radius-value');
        const darkArea        = document.getElementById('dark-area');
        const darkSearchInput = document.getElementById('darkstore-search');
        const darkSearchBtn   = document.getElementById('darkstore-btn');
        const darkResult      = document.getElementById('darkstore-result');
        const darkBtnCenter   = document.getElementById('dark-btn-center');
        const darkBtnMax      = document.getElementById('dark-btn-max');
        const darkBtnClear    = document.getElementById('dark-btn-clear');

        const updateRadiusUI = (km) => {
          darkRadiusValue.textContent = km.toLocaleString('pt-BR',{minimumFractionDigits:1, maximumFractionDigits:1}) + " km";
          const area = Math.PI * (km ** 2);
          darkArea.textContent = "Área coberta: ~" + area.toLocaleString('pt-BR',{maximumFractionDigits:1}) + " km²";
        };

        const drawCircle = (km) => {
          const meters = Math.min(Math.max(km,0),10) * 1000;
          if (darkCircle) darkCircle.remove();
          darkCircle = L.circle(darkBaseLatLng, {
            radius: meters,
            color: '#8c3b3b', weight: 2,
            fillColor: '#8c3b3b', fillOpacity: 0.12
          }).addTo(darkMap);
        };

        // inicial
        const km0 = parseFloat(darkRadiusInput.value);
        updateRadiusUI(km0); drawCircle(km0);

        // eventos
        darkRadiusInput.addEventListener('input', (e)=>{ const k=parseFloat(e.target.value); updateRadiusUI(k); drawCircle(k); });
        darkBtnCenter.addEventListener('click', ()=>{ darkMap.setView(darkBaseLatLng,13); });
        darkBtnMax.addEventListener('click', ()=>{ darkRadiusInput.value=10; updateRadiusUI(10); drawCircle(10); });
        darkBtnClear.addEventListener('click', ()=>{ darkSearchMarkers.forEach(m=>m.remove()); darkSearchMarkers=[]; darkResult.innerHTML=""; });

        async function handleSearch(){
          const q = (darkSearchInput.value||"").trim();
          if (!q) { showToast("Digite um endereço ou CEP."); return; }

          // carrega planilha uma vez (não trava se falhar)
          await loadDarkXls();
          const qLower = q.toLowerCase();
          const inXls = darkAllowedAddresses.some(s => s.toLowerCase().includes(qLower));

          const data = await geocodeGeneric(q);
          if (!data) {
            darkResult.innerHTML = inXls
              ? '<span class="result-pill result-ok">✅ Na base de até 10 km (planilha)</span>'
              : '<span class="result-pill result-bad">Endereço/CEP não encontrado</span>';
            return;
          }
          const [lat, lon, display] = data;
          const mk = L.marker([lat, lon], {title: display}).addTo(darkMap).bindPopup(display);
          darkSearchMarkers.push(mk);
          const dKm = haversine(darkBaseLatLng[0], darkBaseLatLng[1], lat, lon);
          const rKm = parseFloat(darkRadiusInput.value);
          const inside = dKm <= rKm + 0.05;
          const xlsText = inXls ? " (na planilha)" : "";
          darkResult.innerHTML = inside
            ? '<span class="result-pill result-ok">✅ Dentro da área ('+dKm.toLocaleString("pt-BR",{maximumFractionDigits:1})+' km)'+xlsText+'</span>'
            : '<span class="result-pill result-bad">❌ Fora da área ('+dKm.toLocaleString("pt-BR",{maximumFractionDigits:1})+' km)</span>';
          const group = L.featureGroup([mk, darkBaseMarker]);
          darkMap.fitBounds(group.getBounds().pad(0.35));
        }

        darkSearchBtn.addEventListener('click', handleSearch);
        darkSearchInput.addEventListener('keypress', (e)=>{ if (e.key === 'Enter') handleSearch(); });

        // tentar ajustar o tamanho do mapa após animação da aba
        setTimeout(()=> darkMap.invalidateSize(), 250);
        setTimeout(()=> darkMap.invalidateSize(), 800);
        setTimeout(()=> darkMap.invalidateSize(), 1600);
      }

      // começa na aba CEP
      selectTab('cep');


          });
  </script>

  <button id="debugBtn" title="Alternar modo debug">🪲 Debug</button>
  <div id="debugBox"></div>
</body>
</html>



